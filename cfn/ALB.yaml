AWSTemplateFormatVersion: "2010-09-09"
Description: "Application Load Balancer Template"

Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: "Naming Convention"
        Parameters:
          - System
          - Environment
      - Label:
          default: "Tag Information"
        Parameters:
          - Project
          - Owner
          - CostCenter
      - Label:
          default: "Network Configuration"
        Parameters:
          - VpcId
          - PublicSubnetIds
      - Label:
          default: "ALB Configuration"
        Parameters:
          - EnableHttps
          - CertificateArn
    ParameterLabels:
      System:
        default: "System Name"
      Environment:
        default: "Environment"
      Project:
        default: "Project Name"
      Owner:
        default: "Owner Department"
      CostCenter:
        default: "Cost Center"
      VpcId:
        default: "VPC ID"
      PublicSubnetIds:
        default: "Public Subnet IDs"
      EnableHttps:
        default: "Enable HTTPS"
      CertificateArn:
        default: "SSL Certificate ARN"

Parameters:
  System:
    Type: String
    Description: "System name for the naming convention prefix. REQUIRED."
    MinLength: 1
    MaxLength: 50
    AllowedPattern: "^[a-zA-Z0-9-]+$"
    ConstraintDescription: "Must contain only alphanumeric characters and hyphens."

  Environment:
    Type: String
    Description: "Environment for the naming convention prefix. REQUIRED."
    AllowedValues:
      - prod
      - stg
      - dev
    ConstraintDescription: "Must be one of: prod, stg, dev"

  Project:
    Type: String
    Description: "Project name for tagging. REQUIRED."
    MinLength: 1
    MaxLength: 100
    ConstraintDescription: "Project name must be between 1 and 100 characters."

  Owner:
    Type: String
    Description: "Owner department name for tagging. REQUIRED."
    MinLength: 1
    MaxLength: 100
    ConstraintDescription: "Owner must be between 1 and 100 characters."

  CostCenter:
    Type: String
    Description: "Cost center code for tagging (numeric). REQUIRED."
    AllowedPattern: "^[0-9]+$"
    MinLength: 1
    MaxLength: 50
    ConstraintDescription: "Cost center must be numeric and between 1 and 50 digits."

  VpcId:
    Type: AWS::EC2::VPC::Id
    Description: "VPC ID where ALB will be deployed. REQUIRED."

  PublicSubnetIds:
    Type: List<AWS::EC2::Subnet::Id>
    Description: "Comma-separated list of public subnet IDs for ALB deployment. REQUIRED."

  EnableHttps:
    Type: String
    Default: "false"
    AllowedValues:
      - "true"
      - "false"
    Description: "Enable HTTPS listener on the ALB."

  CertificateArn:
    Type: String
    Default: ""
    Description: "ARN of ACM certificate for HTTPS listener. Required if EnableHttps is true."

Conditions:
  UseHttps: !Equals [!Ref EnableHttps, "true"]
  HasCertificate: !Not [!Equals [!Ref CertificateArn, ""]]
  CreateHttpsListener: !And [!Condition UseHttps, !Condition HasCertificate]

Resources:
  # ALB Security Group
  ALBSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: !Sub ${System}-${Environment}-sg-alb-web
      GroupDescription: Security group for Application Load Balancer
      VpcId: !Ref VpcId
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
          Description: Allow HTTP from Internet
        - !If
          - UseHttps
          - IpProtocol: tcp
            FromPort: 443
            ToPort: 443
            CidrIp: 0.0.0.0/0
            Description: Allow HTTPS from Internet
          - !Ref AWS::NoValue
      Tags:
        - Key: Name
          Value: !Sub ${System}-${Environment}-sg-alb-web
        - Key: Environment
          Value: !Ref Environment
        - Key: System
          Value: !Ref System
        - Key: Project
          Value: !Ref Project
        - Key: Owner
          Value: !Ref Owner
        - Key: CostCenter
          Value: !Ref CostCenter

  # Application Load Balancer
  ApplicationLoadBalancer:
    Type: AWS::ElasticLoadBalancingV2::LoadBalancer
    Properties:
      Name: !Sub ${System}-${Environment}-alb-web
      Type: application
      Scheme: internet-facing
      SecurityGroups:
        - !Ref ALBSecurityGroup
      Subnets: !Ref PublicSubnetIds
      Tags:
        - Key: Name
          Value: !Sub ${System}-${Environment}-alb-web
        - Key: Environment
          Value: !Ref Environment
        - Key: System
          Value: !Ref System
        - Key: Project
          Value: !Ref Project
        - Key: Owner
          Value: !Ref Owner
        - Key: CostCenter
          Value: !Ref CostCenter

  # HTTP Listener (always created, redirects to HTTPS if enabled)
  ALBHttpListener:
    Type: AWS::ElasticLoadBalancingV2::Listener
    Properties:
      DefaultActions:
        - !If
          - CreateHttpsListener
          - Type: redirect
            RedirectConfig:
              Protocol: HTTPS
              Port: "443"
              Host: "#{host}"
              Path: "/#{path}"
              Query: "#{query}"
              StatusCode: HTTP_301
          - Type: fixed-response
            FixedResponseConfig:
              StatusCode: "503"
              ContentType: text/plain
              MessageBody: "Service Temporarily Unavailable. No target groups attached."
      LoadBalancerArn: !Ref ApplicationLoadBalancer
      Port: 80
      Protocol: HTTP

  # HTTPS Listener (conditional)
  ALBHttpsListener:
    Type: AWS::ElasticLoadBalancingV2::Listener
    Condition: CreateHttpsListener
    Properties:
      DefaultActions:
        - Type: fixed-response
          FixedResponseConfig:
            StatusCode: "503"
            ContentType: text/plain
            MessageBody: "Service Temporarily Unavailable. No target groups attached."
      LoadBalancerArn: !Ref ApplicationLoadBalancer
      Port: 443
      Protocol: HTTPS
      Certificates:
        - CertificateArn: !Ref CertificateArn
      SslPolicy: ELBSecurityPolicy-TLS-1-2-2017-01

Outputs:
  ALBArn:
    Description: ARN of the Application Load Balancer
    Value: !Ref ApplicationLoadBalancer
    Export:
      Name: !Sub "${AWS::StackName}-ALB-ARN"

  ALBDNSName:
    Description: DNS name of the Application Load Balancer
    Value: !GetAtt ApplicationLoadBalancer.DNSName
    Export:
      Name: !Sub "${AWS::StackName}-ALB-DNS"

  ALBHostedZoneId:
    Description: Hosted Zone ID of the Application Load Balancer
    Value: !GetAtt ApplicationLoadBalancer.CanonicalHostedZoneID
    Export:
      Name: !Sub "${AWS::StackName}-ALB-HostedZoneID"

  ALBSecurityGroupId:
    Description: Security Group ID for Application Load Balancer
    Value: !Ref ALBSecurityGroup
    Export:
      Name: !Sub "${AWS::StackName}-ALB-SG-ID"

  ALBHttpListenerArn:
    Description: ARN of the HTTP Listener
    Value: !Ref ALBHttpListener
    Export:
      Name: !Sub "${AWS::StackName}-ALB-HTTP-Listener-ARN"

  ALBHttpsListenerArn:
    Description: ARN of the HTTPS Listener
    Condition: CreateHttpsListener
    Value: !Ref ALBHttpsListener
    Export:
      Name: !Sub "${AWS::StackName}-ALB-HTTPS-Listener-ARN"

  ALBFullName:
    Description: Full name of the Application Load Balancer (for CloudWatch metrics)
    Value: !GetAtt ApplicationLoadBalancer.LoadBalancerFullName
    Export:
      Name: !Sub "${AWS::StackName}-ALB-FullName"
